<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Students Dashboard</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* –°—Ç–∏–ª–æ–≤–∏ –∑–∞ –≤–∏–∑—É–µ–ª–Ω–∞ –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏—ò–∞ –Ω–∞ –ø—Ä–æ—Å–µ–∫–æ—Ç */
        .avg-high { color: #198754; font-weight: bold; }   /* Green */
        .avg-medium { color: #ffc107; font-weight: bold; } /* Yellow */
        .avg-low { color: #dc3545; font-weight: bold; }    /* Red */
        .dashboard-card { min-height: 120px; }
        .student-card { cursor: pointer; border-radius: 0.5rem; transition: transform 0.2s, box-shadow 0.2s; }
        .student-card:hover { transform: translateY(-5px); box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15); }
    </style>
</head>

<body class="container mt-5 bg-light">


<h1 class="mb-4 text-center text-primary">Students Dashboard üë®‚Äçüéì</h1>

<div class="row row-cols-1 row-cols-md-2 row-cols-lg-4 g-4 mb-5">

    <div class="col">
        <div class="card shadow-sm border-primary dashboard-card">
            <div class="card-body">
                <h6 class="card-title text-muted">Total Students</h6>
                <p class="card-text fs-3 text-primary">{{ students|length }}</p>
                <a href="/add_student" class="btn btn-sm btn-outline-success">Add New Student</a>
            </div>
        </div>
    </div>

    <div class="col">
        <div class="card shadow-sm border-info dashboard-card">
            <div class="card-body">
                <h6 class="card-title text-muted">Overall Average</h6>
                <p class="card-text fs-3 text-info">{{ avg_all|default(0)|round(2) }}</p>
            </div>
        </div>
    </div>

    <div class="col">
        <div class="card shadow-sm border-success dashboard-card">
            <div class="card-body">
                <h6 class="card-title text-muted">Highest Average</h6>
                <p class="card-text fs-6 text-success">
                    {% if highest_avg_student %}
                        {{ highest_avg_student.name }} ({{ highest_avg_student.avg|round(2) }})
                    {% else %}
                        N/A
                    {% endif %}
                </p>
            </div>
        </div>
    </div>

    <div class="col">
        <div class="card shadow-sm border-danger dashboard-card">
            <div class="card-body">
                <h6 class="card-title text-muted">Lowest Average</h6>
                <p class="card-text fs-6 text-danger">
                    {% if lowest_avg_student %}
                        {{ lowest_avg_student.name }} ({{ lowest_avg_student.avg|round(2) }})
                    {% else %}
                        N/A
                    {% endif %}
                </p>
            </div>
        </div>
    </div>
</div>

<div class="card shadow-sm p-3 mb-4">
    <form class="d-flex" action="/" method="GET">
        <input class="form-control me-2" type="search" placeholder="Search by name or city..." name="search" value="{{ search|default('') }}">
        <button class="btn btn-outline-primary" type="submit">Search</button>
        {% if search %}
            <a href="/" class="btn btn-outline-secondary ms-2">Reset</a>
        {% endif %}
    </form>
</div>

<h2 class="mb-3">Student List</h2>
<div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4 mb-5">
    {% for s in students %}
    <div class="col">
        <div class="card student-card shadow-sm h-100">
            <div class="card-body d-flex flex-column">
                <h5 class="card-title">{{ s.name }}</h5>
                <h6 class="card-subtitle mb-2 text-muted">Index: {{ s.index }} | City: {{ s.city }}</h6>
                <p class="card-text mt-2">
                    Average Grade:
                    <span class="fs-4
                        {% if s.avg >= 9 %}avg-high{% elif s.avg >= 7 %}avg-medium{% elif s.avg >= 6 %}avg-low{% else %}text-secondary{% endif %}">
                        {{ s.avg|default('N/A')|round(2) }}
                    </span>
                    {% if s.avg is not none and s.avg <= 7 %}
                        <span class="badge bg-warning text-dark ms-2">RISK</span>
                    {% endif %}
                </p>
                <div class="mt-auto d-flex justify-content-between">
                    <a href="{{ url_for('student_page', id=s._id) }}" class="btn btn-sm btn-primary">View Subjects</a>
                    <button class="btn btn-sm btn-warning" data-bs-toggle="modal" data-bs-target="#editModal{{ loop.index }}">Edit</button>
                    <a href="{{ url_for('delete_student', id=s._id) }}" onclick="return confirm('Are you sure you want to delete {{ s.name }}?')" class="btn btn-sm btn-danger">Delete</a>
                </div>
            </div>
        </div>

        <div class="modal fade" id="editModal{{ loop.index }}" tabindex="-1" aria-labelledby="editModalLabel{{ loop.index }}" aria-hidden="true">
            <div class="modal-dialog">
                <form class="modal-content" method="POST" action="{{ url_for('edit_student', id=s._id) }}">
                    <div class="modal-header">
                        <h5 class="modal-title" id="editModalLabel{{ loop.index }}">Edit Student: {{ s.name }}</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <label>Name:</label>
                        <input name="new_name" class="form-control mb-2" value="{{ s.name }}" required>
                        <label>Index:</label>
                        <input name="new_index" class="form-control mb-2" value="{{ s.index }}">
                        <label>City:</label>
                        <input name="new_city" class="form-control mb-2" value="{{ s.city }}">
                    </div>
                    <div class="modal-footer">
                        <button type="submit" class="btn btn-primary">Save Changes</button>
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    </div>
                </form>
            </div>
        </div>

    </div>
    {% endfor %}
</div>

<div class="card mt-5 shadow-lg border-0">
    <div class="card-body">
        <h5 class="card-title text-center text-secondary mb-3">Average Grade Distribution (–ü—Ä–æ—Å–µ–∫)</h5>
        <div class="p-3">
             <canvas id="avgChart"></canvas>
        </div>
    </div>
</div>

<script>
    const ctx = document.getElementById('avgChart').getContext('2d');
    new Chart(ctx, {
        type: 'bar',
        data: {
            labels: [{% for s in students %}'{{ s.name }}',{% endfor %}],
            datasets: [{
                label: 'Average Grade',
                data: [{% for s in students %}{{ s.avg|default(0) }},{% endfor %}],
                backgroundColor: [
                    {% for s in students %}
                        {% if s.avg >= 9 %}'rgba(25, 135, 84, 0.7)', /* Success - High */
                        {% elif s.avg >= 7 %}'rgba(255, 193, 7, 0.7)', /* Warning - Medium */
                        {% elif s.avg >= 6 %}'rgba(220, 53, 69, 0.7)', /* Danger - Low */
                        {% else %}'rgba(108, 117, 125, 0.7)', /* Secondary - N/A or Fail */
                        {% endif %}
                    {% endfor %}
                ],
                borderColor: [
                    {% for s in students %}
                        {% if s.avg >= 9 %}'rgb(25, 135, 84)',
                        {% elif s.avg >= 7 %}'rgb(255, 193, 7)',
                        {% elif s.avg >= 6 %}'rgb(220, 53, 69)',
                        {% else %}'rgb(108, 117, 125)',
                        {% endif %}
                    {% endfor %}
                ],
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            scales: {
                y: {
                    beginAtZero: true,
                    max: 10
                }
            },
            plugins: {
                legend: {
                    display: false
                },
                title: {
                    display: true,
                    text: 'Student Performance Overview'
                }
            }
        }
    });
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>